<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Upload Invoices</title>
		<style>
			body {
				font-family: sans-serif;
				margin: 40px;
			}

			form {
				background: #f9f9f9;
				padding: 20px;
				border-radius: 8px;
				max-width: 500px;
				margin: auto;
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}

			input[type="text"],
			input[type="date"],
			input[type="number"],
			textarea,
			input[type="file"] {
				width: calc(100% - 22px);
				padding: 10px;
				margin-bottom: 15px;
				border: 1px solid #ddd;
				border-radius: 4px;
			}

			button {
				background-color: #007bff;
				color: white;
				padding: 10px 20px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 16px;
			}

			button:hover {
				background-color: #0056b3;
			}

			button:disabled {
				background-color: #6c757d;
				cursor: not-allowed;
			}

			.download-btn {
				background-color: #28a745;
				/* Green for download */
				color: white;
				padding: 10px 20px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 16px;
				text-decoration: none;
				/* For the <a> tag */
				display: inline-block;
				/* For the <a> tag */
				margin-top: 15px;
			}

			.progress-container {
				background: #f9f9f9;
				padding: 20px;
				border-radius: 8px;
				max-width: 500px;
				margin: auto;
			}

			.download-btn:hover {
				background-color: #218838;
			}

			/* Progress Bar Styles */
			.progress-container {
				display: none;
				margin-top: 20px;
				background: #f8f9fa;
				padding: 20px;
				border-radius: 8px;
				border: 1px solid #dee2e6;
				padding: 20px;
				border-radius: 8px;
				max-width: 500px;
			}

			.progress-bar-wrapper {
				width: 100%;
				height: 25px;
				background-color: #e9ecef;
				border-radius: 12px;
				overflow: hidden;
				margin-bottom: 15px;
			}

			.progress-bar {
				height: 100%;
				background: linear-gradient(90deg, #007bff, #0056b3);
				width: 0%;
				transition: width 0.3s ease;
				border-radius: 12px;
				position: relative;
			}

			.progress-text {
				text-align: center;
				font-weight: bold;
				margin-bottom: 10px;
			}

			.progress-steps {
				font-size: 14px;
				color: #6c757d;
			}

			.progress-step {
				margin: 5px 0;
				padding: 3px 0;
			}

			.progress-step.active {
				color: #007bff;
				font-weight: bold;
			}

			.progress-step.completed {
				color: #28a745;
			}

			.success-message {
				display: none;
				background: #d4edda;
				color: #155724;
				padding: 15px;
				border-radius: 8px;
				margin-top: 20px;
				border: 1px solid #c3e6cb;
				max-width: 500px;
				margin-left: auto;
				margin-right: auto;
			}

			.error-message {
				display: none;
				background: #f8d7da;
				color: #721c24;
				padding: 15px;
				border-radius: 8px;
				margin-top: 20px;
				border: 1px solid #f5c6cb;
				max-width: 500px;
				margin-left: auto;
				margin-right: auto;
			}

			.info-message {
				display: none;
				background: #d1ecf1;
				color: #0c5460;
				padding: 15px;
				border-radius: 8px;
				margin-top: 20px;
				border: 1px solid #bee5eb;
				max-width: 500px;
				margin-left: auto;
				margin-right: auto;
			}

			.job-status-container {
				display: none;
				background: #f8f9fa;
				padding: 20px;
				border-radius: 8px;
				max-width: 500px;
				margin: 20px auto;
				border: 1px solid #dee2e6;
			}

			.job-info {
				margin-bottom: 15px;
				padding: 10px;
				background: white;
				border-radius: 5px;
				border: 1px solid #e9ecef;
			}

			.job-info strong {
				color: #495057;
			}

			.status-badge {
				display: inline-block;
				padding: 4px 8px;
				border-radius: 4px;
				font-size: 12px;
				font-weight: bold;
				text-transform: uppercase;
			}

			.status-pending {
				background-color: #fff3cd;
				color: #856404;
			}

			.status-processing {
				background-color: #d1ecf1;
				color: #0c5460;
			}

			.status-finished {
				background-color: #d4edda;
				color: #155724;
			}

			.status-canceled {
				background-color: #f8d7da;
				color: #721c24;
			}
		</style>
	</head>

	<body>
		<h1>Generador Facturas Selectra Plus CSV</h1>
		<form id="upload-form" enctype="multipart/form-data">
			<label for="csv-file">Sube tu archivo CSV:</label>
			<input type="file" name="csv-file" id="csv-file" accept=".csv" required><br><br>
			<h2>Detalles de Factura </h2>
			<label for="invoice-date">Fecha:</label>
			<input type="date" id="invoice-date" name="invoice-date" required><br>
			<label for="type-contract">Tipo de Contrato:</label>
			<input type="text" id="type-contract" name="type-contract" placeholder="e.g., S.Plus, S.Eco..." required><br>
			<label for="starting-invoice-number">Numero inicial de factura</label>
			<input type="number" id="starting-invoice-number" name="starting-invoice-number" value="1" min="1" required><br>
			<label for="concept">Concepto:</label>
			<textarea id="concept" name="concept" rows="3" placeholder="Description of services/goods" required></textarea><br>
			<label for="quantity">Cantidad:</label>
			<input type="number" id="quantity" name="quantity" value="1" min="1" required><br>
			<label for="rate">Precio:</label>
			<input type="number" id="rate" name="rate" step="0.01" value="100.00" min="0" required><br>
			<label for="taxes">Taxes (%):</label>
			<input type="number" id="taxes" name="taxes" step="0.01" value="21.00" min="0" required><br>
			<button type="submit" id="submit-btn">Generar PDFS</button>
		</form>

		<div class="info-message" id="info-message"></div>
		<div class="success-message" id="success-message"></div>
		<div class="error-message" id="error-message"></div>

		<div class="job-status-container" id="job-status-container">
			<h3>Estado del Trabajo</h3>
			<div class="job-info">
				<strong>Job ID:</strong> <span id="job-id-display">-</span>
			</div>
			<div class="job-info">
				<strong>Estado:</strong> <span id="job-status-display" class="status-badge">-</span>
			</div>
			<div class="job-info">
				<strong>Creado:</strong> <span id="job-created-display">-</span>
			</div>
			<div class="job-info">
				<strong>Actualizado:</strong> <span id="job-updated-display">-</span>
			</div>
			<div class="job-info" id="job-error-container" style="display: none;">
				<strong>Error:</strong> <span id="job-error-display">-</span>
			</div>
			<div style="text-align: center; margin-top: 20px;">
				<button id="download-button" class="download-btn" style="display: none;">Descargar Facturas</button>
			</div>
		</div>

		<div class="progress-container" id="progress-container">
			<div class="progress-text" id="progress-text">Procesando...</div>
			<div class="progress-bar-wrapper">
				<div class="progress-bar" id="progress-bar"></div>
			</div>
			<div class="progress-steps" id="progress-steps">
				<div class="progress-step" id="step-1">ðŸ“„ Reading CSV file...</div>
				<div class="progress-step" id="step-2">ðŸ“‹ Generating HTML invoices...</div>
				<div class="progress-step" id="step-3">ðŸ“„ Converting to PDF...</div>
				<div class="progress-step" id="step-4">ðŸ“¦ Creating ZIP file...</div>
				<div class="progress-step" id="step-5">ðŸ§¹ Cleaning up temporary files...</div>
			</div>
		</div>

		<script>
			let currentJobId = null;
			let statusCheckInterval = null;

			document.getElementById('upload-form').addEventListener('submit', async function (e) {
				e.preventDefault(); // Prevent default form submission

				const submitBtn = document.getElementById('submit-btn');
				const formData = new FormData(this);

				submitBtn.disabled = true;
				submitBtn.textContent = 'Enviando...';

				hideAllMessages();

				try {
					const response = await fetch('/upload', {
						method: 'POST',
						body: formData
					});

					const responseData = await response.json();

					// Show server response info
					showInfoMessage(`
						<strong>Respuesta del servidor:</strong><br>
						Status Code: ${response.status}<br>
						${responseData.message || 'Procesando solicitud...'}<br>
						${responseData.jobId ? `Job ID: ${responseData.jobId}` : ''}
					`);

					if (response.ok && responseData.jobId) {
						currentJobId = responseData.jobId;
						startJobStatusPolling();
					} else {
						showErrorMessage(`Error: ${responseData.message || 'Unknown error occurred'}`);
					}

				} catch (error) {
					showErrorMessage(`Error de conexiÃ³n: ${error.message}`);
				} finally {
					// Re-enable submit button
					submitBtn.disabled = false;
					submitBtn.textContent = 'Generar PDFS';
				}
			});

			async function checkJobStatus() {
				if (!currentJobId) return;

				try {
					const response = await fetch(`/jobs/${currentJobId}/status`);
					const jobData = await response.json();

					if (response.ok && jobData.jobId) {
						updateJobStatusDisplay(jobData);

						// If job is finished, show download button and stop polling
						if (jobData.status === 'finished') {
							stopJobStatusPolling();
							showDownloadButton();
							showSuccessMessage('Â¡Proceso completado! Tu archivo estÃ¡ listo para descargar.');
						} else if (jobData.status === 'canceled') {
							stopJobStatusPolling();
							showErrorMessage(`Error en el procesamiento: ${jobData.msgError || 'Unknown error'}`);
						}
					} else {
						console.error('Error checking job status:', jobData);
					}
				} catch (error) {
					console.error('Error fetching job status:', error);
				}
			}

			function startJobStatusPolling() {
				document.getElementById('job-status-container').style.display = 'block';

				checkJobStatus();

				statusCheckInterval = setInterval(checkJobStatus, 2000);
			}

			function stopJobStatusPolling() {
				if (statusCheckInterval) {
					clearInterval(statusCheckInterval);
					statusCheckInterval = null;
				}
			}

			function updateJobStatusDisplay(jobData) {
				document.getElementById('job-id-display').textContent = jobData.jobId || '-';

				const statusElement = document.getElementById('job-status-display');
				statusElement.textContent = jobData.status || '-';
				statusElement.className = `status-badge status-${jobData.status}`;

				document.getElementById('job-created-display').textContent =
					jobData.createdAt ? new Date(jobData.createdAt).toLocaleString() : '-';
				document.getElementById('job-updated-display').textContent =
					jobData.updatedAt ? new Date(jobData.updatedAt).toLocaleString() : '-';

				// Show/hide error container
				const errorContainer = document.getElementById('job-error-container');
				const errorDisplay = document.getElementById('job-error-display');
				if (jobData.msgError && jobData.msgError.trim() !== '') {
					errorDisplay.textContent = jobData.msgError;
					errorContainer.style.display = 'block';
				} else {
					errorContainer.style.display = 'none';
				}
			}

			function showDownloadButton() {
				const downloadBtn = document.getElementById('download-button');
				downloadBtn.style.display = 'inline-block';
				downloadBtn.onclick = function () {
					window.location.href = `/download/${currentJobId}/`;
				};

			}

			function showInfoMessage(message) {
				const infoMsg = document.getElementById('info-message');
				infoMsg.innerHTML = message;
				infoMsg.style.display = 'block';
			}

			function showSuccessMessage(message) {
				const successMsg = document.getElementById('success-message');
				successMsg.textContent = message;
				successMsg.style.display = 'block';
			}

			function showErrorMessage(message) {
				const errorMsg = document.getElementById('error-message');
				errorMsg.textContent = message;
				errorMsg.style.display = 'block';
			}

			function hideAllMessages() {
				document.getElementById('info-message').style.display = 'none';
				document.getElementById('success-message').style.display = 'none';
				document.getElementById('error-message').style.display = 'none';
			}

			// Clean up interval when page is unloaded
			window.addEventListener('beforeunload', function () {
				stopJobStatusPolling();
			});
		</script>
	</body>

</html>
